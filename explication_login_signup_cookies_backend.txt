LOGIN/SIGNUP/COOKIES - BACKEND BLOGART26

1) Initialisation globale et session
- `config.php` definit `ROOT` et `ROOT_URL`, charge `.env`, la config DB et les helpers globaux.
- Il demarre la session PHP si besoin.
- Pour les routes `/api/*`, seuls ces endpoints sont publics :
  `api/security/signup.php`, `api/security/login.php`, `api/security/disconnect.php`,
  `api/security/cookie-consent.php`.
  Tous les autres `/api/*` exigent `$_SESSION['user_id']`, sinon HTTP 403.

2) Login (backend)
A) Page login admin : `views/backend/security/login.php`
Etapes :
1. `session_start()` puis charge `config.php` et `ctrlSaisies.php`.
2. En POST, nettoie `pseudo` et `password`.
3. Verifie les champs requis.
4. Appelle `verifyRecaptcha(..., 'login')`. Si reCAPTCHA est desactive en env, il valide automatiquement.
5. SQL : `sql_select('MEMBRE', '*', "pseudoMemb = '$pseudo'")`.
6. Si OK et `password_verify($password, passMemb)` passe, met en session :
   `$_SESSION['user_id']`, `$_SESSION['pseudoMemb']`, `$_SESSION['numStat']`.
7. Redirige vers `/index.php`. Sinon affiche une erreur sur la page.

B) Endpoint API login : `api/security/login.php`
Etapes :
1. Charge `config.php`, `ctrlSaisies.php`, puis `session_start()`.
2. En POST, nettoie les entrees et cherche `MEMBRE` via `pseudoMemb`.
3. `password_verify` sur `passMemb`.
4. Si OK : set `$_SESSION['user_id']` + `$_SESSION['pseudoMemb']`, puis redirect `/index.php`.
5. Si KO : redirect `/views/security/login.php?error=...`.
Note : ce chemin differe de la vue backend (`/views/backend/security/login.php`).

Observations :
- Il existe deux implementations de login. La vue backend traite le POST elle-meme ;
  l'endpoint API est separ?.
- Authentification uniquement par session (pas de token "remember me").

3) Signup (backend)
- Vue formulaire : `views/backend/security/signup.php` (POST vers `api/security/signup.php`).
- Endpoint `api/security/signup.php` :
1. `session_start()`, charge `config.php` et `ctrlSaisies.php`.
2. Initialise `$_SESSION['errors']` et `$_SESSION['old']`.
3. reCAPTCHA `verifyRecaptcha(..., 'signup')`.
4. Validations :
   - `prenomMemb`, `nomMemb` requis.
   - `pseudoMemb` longueur 6..70 et unique (SELECT).
   - `passMemb` longueur 8..15 + complexite (maj, min, chiffre, special) + confirmation.
   - `eMailMemb` valide + confirmation + unique (SELECT).
   - `accordMemb` doit etre coche (RGPD).
5. Si OK :
   - `password_hash` du mot de passe.
   - `sql_insert` dans `MEMBRE` avec `nomMemb, prenomMemb, pseudoMemb, passMemb, eMailMemb,
     dtCreaMemb, accordMemb, numStat`.
   - `numStat` = 3 (role par defaut).
   - `$_SESSION['success']`, redirect `views/backend/security/login.php`.
6. Si erreurs :
   - garde erreurs + old data en session, redirect `views/backend/security/signup.php`.

4) Logout
- `api/security/disconnect.php` :
  `session_start()` -> `session_unset()` -> `session_destroy()` -> redirect `/index.php`.

5) Session et controle d'acces
- Cookie de session : `PHPSESSID`.
- Etat auth : `$_SESSION['user_id']`.
- Roles/permissions : `$_SESSION['numStat']` dans certains helpers
  (`functions/redirec.php`, `functions/redirecmodo.php`).

6) Consentement cookies (RGPD)
- UI : `header.php` inclut `includes/libs/cookie-consent.php` et appelle
  `getCookieConsent($DB)`.
- Si `null`, une popup propose accepter/refuser.
- Le choix envoie un POST vers `api/security/cookie-consent.php` avec `consent=1|0`.

Logique backend :
- `api/security/cookie-consent.php` :
  1. N'accepte que POST (405 sinon).
  2. Normalise la valeur a 1/0.
  3. Assure la connexion SQL (`sql_connect`) et appelle `saveCookieConsent($DB, $consent)`.
  4. Retourne HTTP 204.

- `includes/libs/cookie-consent.php` :
  - Nom du cookie : `bec_cookie_consent`.
  - Duree : 1 an.
  - `setcookie(..., HttpOnly=true, Secure=false, path=/)`.
  - `getCookieConsent($pdo)` :
    - Connecte : lit `membre.cookieMemb`. Si vide et cookie navigateur existe, sync cookie -> DB.
    - Anonyme : lit seulement le cookie navigateur.
    - Aucun choix : `null`.
  - `saveCookieConsent($pdo, consent)` :
    - Connecte : update `membre.cookieMemb` + ecrit le cookie.
    - Anonyme : ecrit uniquement le cookie.

7) Champs DB impliques (table `MEMBRE`)
- `passMemb` : mot de passe hash? (`password_hash`).
- `pseudoMemb`, `eMailMemb` : unicite verifiee a l'inscription.
- `cookieMemb` : consentement (0/1) pour membres connectes.
- `accordMemb` : consentement RGPD a l'inscription.
- `numStat` : role/niveau (defaut 3 a l'inscription).
- `dtCreaMemb`, `dtMajMemb` : timestamps.

8) Resume rapide des flux
- Login : form -> recaptcha -> SELECT MEMBRE -> password_verify -> session -> redirect.
- Signup : form -> recaptcha + validations -> INSERT MEMBRE -> success -> redirect.
- Cookies : popup -> POST consent -> write cookie + update DB si connecte.
